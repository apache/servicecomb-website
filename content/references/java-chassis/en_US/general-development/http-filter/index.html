<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Http Filter - ServiceComb Java Chassis Developers Guide</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Http Filter";
        var mkdocs_page_input_path = "general-development/http-filter.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> ServiceComb Java Chassis Developers Guide
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../start/terminology/">Glossary</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../start/architecture/">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../start/development-environment/">Development environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../start/first-sample/">Develop the first microservice</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Development Service Provider</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/definition/service-definition/">Service definition</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/define-contract/">Service contract definition</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/code-first/">Implicit API definition</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/swagger-annotation/">Use Swagger annotations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/springmvc/">Develop with SpringMVC</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/jaxrs/">Develop with JAX-RS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/transparent-rpc/">Develop with Transparent RPC</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/interface-constraints/">Interface definition and data type</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/listen-address-and-publish-address/">Service listening address and publishing address</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/thread-pool/">Thread pool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Service Configuration</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../build-provider/configuration/ratelimite-strategy/">Rate Limiting Policy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../build-provider/configuration/downgrade-strategy/">Fallback Policy</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../build-provider/configuration/parameter-validator/">Parameter Validator</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/bootup/">Boot-up Process</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-provider/access-log-configuration/">Access Log Configuration</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Writing Service Consumer</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-consumer/common-configuration/">Consumer common configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-consumer/using-resttemplate/">Using Rest Template</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-consumer/using-AsyncRestTemplate/">Using AsyncRestTemplate</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-consumer/develop-consumer-using-rpc/">Using with RPC</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-consumer/with-contract/">Contract</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Invoke control</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../build-consumer/circuit-breaker/">Circuit Breaker</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../build-consumer/flow-control/">Flow Control</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../build-consumer/fault-injection/">Fault Injection</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build-consumer/3rd-party-service-invoke/">Invoke 3rd-party REST services</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Transports</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../transports/rest-over-servlet/">REST over Servlet</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../transports/rest-over-vertx/">REST over Vertx</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../transports/highway-rpc/">Highway</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../transports/http2/">HTTP2</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">General Development</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../visit-sc/">Access Service Center</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../metrics/">Metrics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../microservice-invocation-chain/">Microservice invocation chain</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../customized-tracing/">Customized-Tracing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../local-develop-test/">Local development and testing</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Http Filter</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../file-upload/">File Uploading</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../file-download/">File Downloading</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../reactive/">Reactive Programing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dnsconfig/">DNS Custom Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dai-li-she-zhi/">Proxy Settings</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../report-framework-version/">Report framework version</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cross-app-invocation/">Cross-application invocation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../secret-field/">Customized serialization and deserialization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../context/">Using Context to pass control messages</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../produceprocess/">Return value serialization extension</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CORS/">CORS mechanism</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../AlarmEvent/">Get fuse and instance isolation alarm event information</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../shutdown/">Shutdown gracefully</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../error-handling/">Handling exceptions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../multienvironment/">Multi-environment isolation between microservice instances</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../thread-model/">Thread Model</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Configuration</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../config/general-config/">General config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../config/inject-config/">Configuration injection</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Service Capability Open</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../edge/open-service/">Intruductions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../edge/by-servicecomb-sdk/">Using Edge Service</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../edge/nginx/">Using confd and Nginx as edge services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../edge/zuul/">Use zuul as edge services</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Service Packing and Running</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../packaging/standalone/">Standalone mode</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../packaging/web-container/">WEB container mode</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Micro Service Security</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../security/tls/">Using TLS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../security/rsa/">Using RSA certification</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Using java chassis in Spring Boot</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../using-java-chassis-in-spring-boot/using-java-chassis-in-spring-boot/">Intruductions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using-java-chassis-in-spring-boot/components-for-spring-boot/">spring boot starter for java-chassis</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using-java-chassis-in-spring-boot/java-application/">JAVA application development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using-java-chassis-in-spring-boot/web-application/">Web development method development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using-java-chassis-in-spring-boot/diff-between-java-web/">The difference between JAVA application method and Web development method</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using-java-chassis-in-spring-boot/diff-spring-mvc/">The difference in Spring MVC mode</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Handlers reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../references-handlers/intruduction/">Intruductions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references-handlers/loadbalance/">Load Balancing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../references-handlers/publickey/">Public key authentication</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">FAQ</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../question-and-answer/question_answer/">Q & A</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../question-and-answer/faq/">FAQ</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../question-and-answer/interface-compatibility/">Micro Service Interface Compatibility FAQ</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">ServiceComb Java Chassis Developers Guide</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>General Development &raquo;</li>
      <li>Http Filter</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>In some scenarios, the service uses http instead of https as the network transmission channel. To prevent the falsification or tampering request, consumer and the producer must be provided a method to signature the http stream.</p>
<p>The signature method is carried using the org.apache.servicecomb.common.rest.filter.HttpClientFilter and org.apache.servicecomb.common.rest.filter.HttpServerFilter interfaces. It is recommended that the http stream related logic use the Filter mechanism here, and the contract The parameter related logic uses the Handler mechanism.</p>
<p>About the use of the Filter interface, please reference [demo-signature] (https://github.com/ServiceComb/ServiceComb-Java-Chassis/tree/master/demo/demo-signature).</p>
<h1 id="1-overview">1 Overview</h1>
<p>The Filter mechanism is loaded using the Java standard SPI mechanism.</p>
<p>Both HttpClientFilter and HttpServerFilter allow multiple loads:</p>
<ul>
<li>
<p>The order of execution between instances is determined by the return value of getOrder</p>
</li>
<li>
<p>If getOrder returns the same value, the corresponding instance order is randomly determined</p>
</li>
</ul>
<p>Whether it is request or response, read the body stream, use getBodyBytes\ (), the return value may be null (such as scenario of getting an invocation), if not null, the corresponding stream length, Obtain through getBodyBytesLength\ (\ ).</p>
<blockquote>
<p><strong><em>Tips</em></strong>: 
The beforeSendRequest of HttpClientFilter is executed in the current thread of the interface call, and the afterReceiveResponse is executed in the business thread pool.</p>
<p>The afterReceiveRequest of HttpServerFilter is executed in the business thread pool, beforeSendResponse and beforeSendResponseAsync may be executed in the business thread pool or the network thread pool. Make sure that blocking operations can not occur.</p>
<p>The bottom layer of Java Chassis is an asynchronous framework, with frequent thread switching. When the business extends Filter, if it involves obtaining the thread context through ThreadLocal, the acquisition may be empty. For this scenario, it is recommended to use InhritableThreadLocal instead of ThreadLocal to store data, or to use extended Handler instead of Filter.</p>
</blockquote>
<h1 id="2httpclientfilter">2.HttpClientFilter</h1>
<p>The system has two built-in HttpClientFilter. Note that the order value does not conflict when extending the function:</p>
<ul>
<li>
<p>org.apache.servicecomb.provider.springmvc.reference.RestTemplateCopyHeaderFilter, order value is Integer.MIN_VALUE</p>
</li>
<li>
<p>org.apache.servicecomb.transport.rest.client.http.DefaultHttpClientFilter, order value is Integer.MAX_VALUE</p>
</li>
</ul>
<h2 id="21-prototype">2.1 Prototype</h2>
<pre><code>public interface HttpClientFilter {
  int getOrder();

  void beforeSendRequest(Invocation invocation, HttpServletRequestEx requestEx);

  // if finished, then return a none null response
  // if return a null response, then sdk will call next filter.afterReceive
  Response afterReceiveResponse(Invocation invocation, HttpServletResponseEx responseEx);
}
</code></pre>
<h2 id="22-beforesendrequest">2.2 beforeSendRequest</h2>
<p>Used to send a request after the stream has been generated
calculate the signature based on url, header, query, and stream
then set to the header \ (requestEx.setHeader).</p>
<p>From the invocation, you can get the various metadata and the object parameters of this call (the stream is generated according to these parameters).</p>
<h2 id="23-afterreceiveresponse">2.3 afterReceiveResponse</h2>
<p>Used to calculate the signature according to the header and the stream after receiving the response from the network, and compare it with the signature in the header. If the signature is incorrect, directly construct a Response.</p>
<p>As a return value, the framework will interrupt calls to other HttpClientFilters as long as it does not return NULL.</p>
<h1 id="3-httpserverfilter">3 HttpServerFilter</h1>
<h2 id="31-prototype">3.1 Prototype</h2>
<pre><code>public interface HttpServerFilter {
  int getOrder();

  default boolean needCacheRequest(OperationMeta operationMeta) {
    return false;
  }

  // if finished, then return a none null response
  // if return a null response, then sdk will call next filter.afterReceiveRequest
  Response afterReceiveRequest(Invocation invocation, HttpServletRequestEx requestEx);

  // invocation maybe null
  void beforeSendResponse(Invocation invocation, HttpServletResponseEx responseEx);
}
</code></pre>
<h2 id="32-needcacherequest">3.2 needCacheRequest</h2>
<p>Unlike HttpClientFilter, the ability to decide whether to cache requests is added.</p>
<p>This is because ServiceComb can not only run in standalone mode but also run in web container (such as Tomcat). In the implementation of a servlet, request stream can only be read once, and does not necessarily support reset (such as Tomcat), RESTful The framework needs to perform deserialization. It needs to read the body stream. The signature logic also needs to read the body stream. If the default processing is used, one of the functions cannot be implemented.</p>
<p>So when running in a web container scenario, all HttpServerFilters, as long as there is a return request that needs to be cached, the body stream will be copied and saved to support repeated reads.</p>
<p>The input parameter is the metadata corresponding to the request, and the service can decide whether the cache request is needed for the request.</p>
<h2 id="33-afterreceiverequest">3.3 afterReceiveRequest</h2>
<p>After receiving the request, the signature is calculated according to the URL, header, query, and code stream, and compared with the signature in the header. If the signature is incorrect, a Response is directly constructed as the return value. As long as the NULL is not returned, the framework will interrupt the other HttpClientFilter Call.</p>
<h2 id="34-beforesendresponse">3.4 beforeSendResponse</h2>
<p>Before sending a response, the signature is calculated according to the header and the stream and set to the header.</p>
<p>Because the invocation has not yet been constructed, the call flow has gone wrong, so the invocation may be null.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../local-develop-test/" class="btn btn-neutral float-left" title="Local development and testing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../file-upload/" class="btn btn-neutral float-right" title="File Uploading">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../local-develop-test/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../file-upload/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
